---
title: "WalmartSales"
format: pdf
editor: visual
---

## Libraries and Data

```{r}

library(ggplot2)
library(tidyverse)
library(tidymodels)
library(patchwork)
library(tune)
library(vroom)
library(dplyr)
library(embed)
library(kknn)


train <- vroom('./train.csv')
test <- vroom('./test.csv')
features <- vroom("./features.csv")
stores   <- vroom("./stores.csv")


```

## EDA Stuff

```{r}

# how many stores / depts / weeks?
train %>%
  summarise(
    n_rows   = n(),
    n_store  = n_distinct(Store),
    n_dept   = n_distinct(Dept),
    min_date = min(Date),
    max_date = max(Date)
  )

# sales summary
train %>%
  summarise(
    mean_sales = mean(Weekly_Sales),
    median_sales = median(Weekly_Sales),
    min_sales = min(Weekly_Sales),
    max_sales = max(Weekly_Sales)
  )

# check for negative sales
train %>%
  filter(Weekly_Sales < 0) %>%
  count()


features %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  t()


```

```{r}

store_example <- 1
dept_example  <- 1

train %>%
  filter(Store == store_example, Dept == dept_example) %>%
  ggplot(aes(x = Date, y = Weekly_Sales, color = IsHoliday)) +
  geom_line() +
  labs(title = paste("Store", store_example, "- Dept", dept_example),
       y = "Weekly Sales", x = "Date")

ggplot(train, aes(x = Weekly_Sales)) +
  geom_histogram(bins = 50) +
  labs(title = "Distribution of Weekly Sales")



```

We've got some issues, not super clear from the code I was able to produce above.\
BUT\
We need to figure out a good way to join data together (join features to train on store and date)\
There are some stores that only have like 5 data points to use in predicting

And there are holes in the data where we need to figure out what to do with. maybe imputation or something.

## Time Series

```{r}

markdown_vars <- c("MarkDown1","MarkDown2","MarkDown3","MarkDown4","MarkDown5")

features_clean <- features %>%
  mutate(across(all_of(markdown_vars),
                ~ replace_na(.x, 0)))

features_clean <- features_clean %>%
  mutate(TotalMarkdown = MarkDown1 + MarkDown2 + MarkDown3 + MarkDown4 + MarkDown5)

features_clean <- features_clean %>%
  mutate(MarkdownFlag = if_else(TotalMarkdown > 0, 1, 0))

features_clean <- features_clean %>%
  select(-MarkDown1, -MarkDown2, -MarkDown3, -MarkDown4, -MarkDown5)


train_joined <- train %>%
  left_join(features_clean, by = c("Store", "Date"))

test_joined <- test %>%
  left_join(features_clean, by = c("Store", "Date"))

```

## Prophet Stuff

```{r}

library(prophet)

## Choose store & dept
store <- 12
dept  <- 12

## Filter train
sd_train <- train_joined %>%
  filter(Store == store, Dept == dept) %>%
  rename(y = Weekly_Sales, ds = Date)

## Filter test
sd_test <- test_joined %>%
  filter(Store == store, Dept == dept) %>%
  rename(ds = Date)

## Impute regressors ----------------------------------------
# median (or mean) from TRAIN ONLY
unemp_med <- median(sd_train$Unemployment, na.rm = TRUE)
temp_med  <- median(sd_train$Temperature,  na.rm = TRUE)
tm_med    <- median(sd_train$TotalMarkdown, na.rm = TRUE)

sd_train <- sd_train %>%
  mutate(
    Unemployment  = ifelse(is.na(Unemployment)  | is.nan(Unemployment),  unemp_med, Unemployment),
    Temperature   = ifelse(is.na(Temperature)   | is.nan(Temperature),   temp_med,  Temperature),
    TotalMarkdown = ifelse(is.na(TotalMarkdown) | is.nan(TotalMarkdown), tm_med,    TotalMarkdown)
  )

sd_test <- sd_test %>%
  mutate(
    Unemployment  = ifelse(is.na(Unemployment)  | is.nan(Unemployment),  unemp_med, Unemployment),
    Temperature   = ifelse(is.na(Temperature)   | is.nan(Temperature),   temp_med,  Temperature),
    TotalMarkdown = ifelse(is.na(TotalMarkdown) | is.nan(TotalMarkdown), tm_med,    TotalMarkdown)
  )


prophet_model <- prophet() %>%
  add_regressor("Unemployment") %>%
  add_regressor("TotalMarkdown") %>%
  add_regressor("Temperature") %>%
  fit.prophet(df = sd_train)



## Predict Using Fitted prophet Model
fitted_vals <- predict(prophet_model, df=sd_train) #For Plotting Fitted Values
test_preds <- predict(prophet_model, df=sd_test) #Predictions are called "yhat"

## Plot Fitted and Forecast on Same Plot
plot1 <- ggplot() +
  geom_line(data = sd_train, mapping = aes(x = ds, y = y, color = "Data")) +
  geom_line(data = fitted_vals, mapping = aes(x = as.Date(ds), y = yhat, color =
                                                "Fitted")) +
  geom_line(data = test_preds, mapping = aes(x = as.Date(ds), y = yhat, color =
                                               "Forecast")) +
  scale_color_manual(values = c("Data" = "black", "Fitted" = "blue", "Forecast" =
                                  "red")) +
  labs(color="")


## Choose store & dept
store <- 16
dept  <- 16

## Filter train
sd_train <- train_joined %>%
  filter(Store == store, Dept == dept) %>%
  rename(y = Weekly_Sales, ds = Date)

## Filter test
sd_test <- test_joined %>%
  filter(Store == store, Dept == dept) %>%
  rename(ds = Date)

## Impute regressors ----------------------------------------
# median (or mean) from TRAIN ONLY
unemp_med <- median(sd_train$Unemployment, na.rm = TRUE)
temp_med  <- median(sd_train$Temperature,  na.rm = TRUE)
tm_med    <- median(sd_train$TotalMarkdown, na.rm = TRUE)

sd_train <- sd_train %>%
  mutate(
    Unemployment  = ifelse(is.na(Unemployment)  | is.nan(Unemployment),  unemp_med, Unemployment),
    Temperature   = ifelse(is.na(Temperature)   | is.nan(Temperature),   temp_med,  Temperature),
    TotalMarkdown = ifelse(is.na(TotalMarkdown) | is.nan(TotalMarkdown), tm_med,    TotalMarkdown)
  )

sd_test <- sd_test %>%
  mutate(
    Unemployment  = ifelse(is.na(Unemployment)  | is.nan(Unemployment),  unemp_med, Unemployment),
    Temperature   = ifelse(is.na(Temperature)   | is.nan(Temperature),   temp_med,  Temperature),
    TotalMarkdown = ifelse(is.na(TotalMarkdown) | is.nan(TotalMarkdown), tm_med,    TotalMarkdown)
  )


prophet_model <- prophet() %>%
  add_regressor("Unemployment") %>%
  add_regressor("TotalMarkdown") %>%
  add_regressor("Temperature") %>%
  fit.prophet(df = sd_train)



## Predict Using Fitted prophet Model
fitted_vals <- predict(prophet_model, df=sd_train) #For Plotting Fitted Values
test_preds <- predict(prophet_model, df=sd_test) #Predictions are called "yhat"

plot2 <- ggplot() +
  geom_line(data = sd_train, mapping = aes(x = ds, y = y, color = "Data")) +
  geom_line(data = fitted_vals, mapping = aes(x = as.Date(ds), y = yhat, color =
                                                "Fitted")) +
  geom_line(data = test_preds, mapping = aes(x = as.Date(ds), y = yhat, color =
                                               "Forecast")) +
  scale_color_manual(values = c("Data" = "black", "Fitted" = "blue", "Forecast" =
                                  "red")) +
  labs(color="")

plot1 + plot2
```
